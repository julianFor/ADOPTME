const authController = require('../../../controllers/authController');

// Mock de los módulos antes de importar
jest.mock('../../../models/User');
jest.mock('jsonwebtoken');
jest.mock('bcryptjs');
jest.mock('validator');
jest.mock('../../../config/auth.config');

describe('Controller - Auth', () => {
  let req, res;
  let mockUser, User, jwt, bcrypt;

  beforeEach(() => {
    jest.clearAllMocks();

    // Configurar objeto request y response mock
    req = {
      body: {},
      userRole: 'admin',
      userId: '507f1f77bcf86cd799439011',
      params: {}
    };

    res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn().mockReturnThis(),
      send: jest.fn().mockReturnThis()
    };

    // Obtener los mocks
    User = require('../../../models/User');
    jwt = require('jsonwebtoken');
    bcrypt = require('bcryptjs');

    mockUser = {
      _id: '507f1f77bcf86cd799439012',
      username: 'testuser',
      email: 'test@example.com',
      password: 'hashedpassword',
      role: 'adoptante',
      toObject: jest.fn().mockReturnValue({
        _id: '507f1f77bcf86cd799439012',
        username: 'testuser',
        email: 'test@example.com',
        role: 'adoptante'
      })
    };
  });

  describe('signup', () => {
    test('debe registrar un usuario correctamente', async () => {
      req.body = {
        username: 'newuser',
        email: 'newuser@example.com',
        password: 'password123'
      };

      User.mockImplementation(() => ({
        save: jest.fn().mockResolvedValue(mockUser)
      }));

      jwt.sign.mockReturnValue('mocktoken123');

      await authController.signup(req, res);

      expect(res.status).toHaveBeenCalledWith(201);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: true,
          message: 'Usuario registrado exitosamente',
          token: 'mocktoken123'
        })
      );
    });

    test('debe retornar error 400 si faltan campos requeridos', async () => {
      req.body = {
        username: 'newuser',
        // Faltan email y password
      };

      await authController.signup(req, res);

      expect(res.status).toHaveBeenCalledWith(400);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Todos los campos son obligatorios'
        })
      );
    });

    test('debe manejar duplicado de email correctamente', async () => {
      req.body = {
        username: 'newuser',
        email: 'existing@example.com',
        password: 'password123'
      };

      const error = new Error('Duplicate key error');
      error.code = 11000;
      error.keyPattern = { email: 1 };

      User.mockImplementation(() => ({
        save: jest.fn().mockRejectedValue(error)
      }));

      await authController.signup(req, res);

      expect(res.status).toHaveBeenCalledWith(400);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          field: 'email'
        })
      );
    });

    test('debe manejar errores del servidor', async () => {
      req.body = {
        username: 'newuser',
        email: 'newuser@example.com',
        password: 'password123'
      };

      User.mockImplementation(() => ({
        save: jest.fn().mockRejectedValue(new Error('Database error'))
      }));

      await authController.signup(req, res);

      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Error al registrar usuario'
        })
      );
    });
  });;

  describe('signin', () => {
    test('debe autenticar un usuario correctamente', async () => {
      req.body = {
        email: 'user@example.com',
        password: 'password123'
      };

      const signinUser = {
        _id: '507f1f77bcf86cd799439011',
        email: 'user@example.com',
        role: 'adoptante',
        comparePassword: jest.fn().mockResolvedValue(true),
        toObject: jest.fn().mockReturnValue({
          _id: '507f1f77bcf86cd799439011',
          email: 'user@example.com',
          role: 'adoptante'
        })
      };

      User.findOne = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(signinUser)
      });

      jwt.sign.mockReturnValue('authtoken123');

      await authController.signin(req, res);

      expect(res.status).toHaveBeenCalledWith(200);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: true,
          message: 'Autenticación exitosa',
          token: 'authtoken123'
        })
      );
    });

    test('debe retornar error 400 si faltan email o password', async () => {
      req.body = {
        email: 'user@example.com'
        // Falta password
      };

      await authController.signin(req, res);

      expect(res.status).toHaveBeenCalledWith(400);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Email y contraseña son requeridos'
        })
      );
    });

    test('debe retornar error 404 si usuario no existe', async () => {
      req.body = {
        email: 'nonexistent@example.com',
        password: 'password123'
      };

      User.findOne = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(null)
      });

      await authController.signin(req, res);

      expect(res.status).toHaveBeenCalledWith(404);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Usuario no encontrado'
        })
      );
    });

    test('debe retornar error 401 si contraseña es incorrecta', async () => {
      req.body = {
        email: 'user@example.com',
        password: 'wrongpassword'
      };

      const signinUser = {
        _id: '507f1f77bcf86cd799439011',
        email: 'user@example.com',
        role: 'adoptante',
        comparePassword: jest.fn().mockResolvedValue(false)
      };

      User.findOne = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(signinUser)
      });

      await authController.signin(req, res);

      expect(res.status).toHaveBeenCalledWith(401);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Credenciales inválidas'
        })
      );
    });

    test('debe validar formato de email', async () => {
      req.body = {
        email: 'invalid-email',
        password: 'password123'
      };

      await authController.signin(req, res);

      expect(res.status).toHaveBeenCalledWith(400);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Formato de email inválido'
        })
      );
    });
  });;

  describe('getUserById', () => {
    test('debe obtener un usuario por ID correctamente', async () => {
      req.params = { id: '507f1f77bcf86cd799439011' };

      User.findById = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(mockUser)
      });

      await authController.getUserById(req, res);

      expect(res.status).toHaveBeenCalledWith(200);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: true,
          user: mockUser
        })
      );
    });

    test('debe retornar error 404 si usuario no existe', async () => {
      req.params = { id: '507f1f77bcf86cd799439011' };

      User.findById = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(null)
      });

      await authController.getUserById(req, res);

      expect(res.status).toHaveBeenCalledWith(404);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Usuario no encontrado'
        })
      );
    });

    test('debe prohibir a adoptante ver perfil de otro usuario', async () => {
      req.params = { id: '507f1f77bcf86cd799439012' };
      req.userRole = 'adoptante';
      req.userId = '507f1f77bcf86cd799439011';

      const otherUser = { ...mockUser, _id: '507f1f77bcf86cd799439012' };

      User.findById = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(otherUser)
      });

      await authController.getUserById(req, res);

      expect(res.status).toHaveBeenCalledWith(403);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'No tienes permiso para ver este perfil'
        })
      );
    });
  });

  describe('deleteUser', () => {
    test('debe eliminar un usuario si es admin', async () => {
      req.params = { id: '507f1f77bcf86cd799439011' };
      req.userRole = 'admin';

      User.findByIdAndDelete = jest.fn().mockResolvedValue(mockUser);

      await authController.deleteUser(req, res);

      expect(res.status).toHaveBeenCalledWith(200);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: true,
          message: 'Usuario eliminado correctamente'
        })
      );
    });

    test('debe prohibir eliminar usuario si no es admin', async () => {
      req.params = { id: '507f1f77bcf86cd799439011' };
      req.userRole = 'adoptante';

      await authController.deleteUser(req, res);

      expect(res.status).toHaveBeenCalledWith(403);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Solo administradores del sistema pueden eliminar usuarios'
        })
      );
    });

    test('debe retornar error 404 si usuario no existe', async () => {
      req.params = { id: '507f1f77bcf86cd799439011' };
      req.userRole = 'admin';

      User.findByIdAndDelete = jest.fn().mockResolvedValue(null);

      await authController.deleteUser(req, res);

      expect(res.status).toHaveBeenCalledWith(404);
      expect(res.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Usuario no encontrado'
        })
      );
    });
  });
});
