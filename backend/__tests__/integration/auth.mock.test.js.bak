const authController = require('../../../controllers/authController');

// Mock de los módulos antes de importar express
jest.mock('../../../models/User');
jest.mock('jsonwebtoken');
jest.mock('bcryptjs');
jest.mock('validator');
jest.mock('../../../config/auth.config');

const request = require('supertest');
const express = require('express');

// Crear una app de prueba
const createTestApp = () => {
  const app = express();
  app.use(express.json());

  // Simular rutas
  app.post('/api/auth/signup', authController.signup);
  app.post('/api/auth/signin', authController.signin);
  app.get('/api/auth/user/:id', authController.getUserById);

  return app;
};

describe('Integration - Auth Routes', () => {
  let app;
  let User, jwt;

  beforeEach(() => {
    app = createTestApp();
    jest.clearAllMocks();
    User = require('../../../models/User');
    jwt = require('jsonwebtoken');
  });

  describe('POST /api/auth/signup', () => {
    test('debe registrar un usuario correctamente', async () => {
      const mockUser = {
        _id: '507f1f77bcf86cd799439012',
        username: 'newuser',
        email: 'newuser@example.com',
        password: 'hashedpassword',
        role: 'adoptante',
        toObject: jest.fn().mockReturnValue({
          _id: '507f1f77bcf86cd799439012',
          username: 'newuser',
          email: 'newuser@example.com',
          role: 'adoptante'
        })
      };

      User.mockImplementation(() => ({
        save: jest.fn().mockResolvedValue(mockUser)
      }));

      jwt.sign.mockReturnValue('mocktoken123');

      const response = await request(app)
        .post('/api/auth/signup')
        .send({
          username: 'newuser',
          email: 'newuser@example.com',
          password: 'password123'
        });

      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body.token).toBeDefined();
      expect(response.body.user.username).toBe('newuser');
    });

    test('debe retornar error si faltan campos', async () => {
      const response = await request(app)
        .post('/api/auth/signup')
        .send({
          username: 'newuser'
          // Faltan email y password
        });

      expect(response.status).toBe(400);
      expect(response.body.success).toBe(false);
    });
  });

  describe('POST /api/auth/signin', () => {
    test('debe autenticar un usuario con credenciales correctas', async () => {
      const mockUser = {
        _id: '507f1f77bcf86cd799439011',
        email: 'user@example.com',
        role: 'adoptante',
        comparePassword: jest.fn().mockResolvedValue(true),
        toObject: jest.fn().mockReturnValue({
          _id: '507f1f77bcf86cd799439011',
          email: 'user@example.com',
          role: 'adoptante'
        })
      };

      User.findOne = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(mockUser)
      });

      jwt.sign.mockReturnValue('authtoken123');

      const response = await request(app)
        .post('/api/auth/signin')
        .send({
          email: 'user@example.com',
          password: 'password123'
        });

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.token).toBe('authtoken123');
    });

    test('debe retornar error con credenciales incorrectas', async () => {
      const mockUser = {
        _id: '507f1f77bcf86cd799439011',
        email: 'user@example.com',
        role: 'adoptante',
        comparePassword: jest.fn().mockResolvedValue(false)
      };

      User.findOne = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(mockUser)
      });

      const response = await request(app)
        .post('/api/auth/signin')
        .send({
          email: 'user@example.com',
          password: 'wrongpassword'
        });

      expect(response.status).toBe(401);
      expect(response.body.success).toBe(false);
      expect(response.body.message).toBe('Credenciales inválidas');
    });

    test('debe retornar error si usuario no existe', async () => {
      User.findOne = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(null)
      });

      const response = await request(app)
        .post('/api/auth/signin')
        .send({
          email: 'nonexistent@example.com',
          password: 'password123'
        });

      expect(response.status).toBe(404);
      expect(response.body.success).toBe(false);
      expect(response.body.message).toBe('Usuario no encontrado');
    });
  });

  describe('GET /api/auth/user/:id', () => {
    test('debe obtener información del usuario', async () => {
      const mockUser = {
        _id: '507f1f77bcf86cd799439011',
        username: 'testuser',
        email: 'test@example.com',
        role: 'adoptante'
      };

      User.findById = jest.fn().mockReturnValue({
        select: jest.fn().mockResolvedValue(mockUser)
      });

      const response = await request(app)
        .get('/api/auth/user/507f1f77bcf86cd799439011');

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.user.username).toBe('testuser');
    });
  });
});
